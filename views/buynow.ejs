<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout | Confirm Your Purchase</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #6366f1;
      --primary-hover: #4f46e5;
      --secondary-color: #f59e0b;
      --success-color: #10b981;
      --danger-color: #ef4444;
      --dark-color: #1e293b;
      --light-color: #f8fafc;
      --text-dark: #1e293b;
      --text-light: #64748b;
      --bg-light: #ffffff;
      --bg-dark: #0f172a;
      --card-bg-light: #ffffff;
      --card-bg-dark: #1e293b;
      --border-light: #e2e8f0;
      --border-dark: #334155;
      --shadow-color: rgba(0, 0, 0, 0.1);
    }

    [data-theme="dark"] {
      --primary-color: #818cf8;
      --primary-hover: #6366f1;
      --secondary-color: #fbbf24;
      --success-color: #34d399;
      --danger-color: #f87171;
      --dark-color: #f8fafc;
      --light-color: #1e293b;
      --text-dark: #f8fafc;
      --text-light: #94a3b8;
      --bg-light: #0f172a;
      --bg-dark: #1e293b;
      --card-bg-light: #1e293b;
      --card-bg-dark: #334155;
      --border-light: #334155;
      --border-dark: #475569;
      --shadow-color: rgba(0, 0, 0, 0.3);
    }

    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--bg-light);
      color: var(--text-dark);
      transition: all 0.3s ease;
    }

    .theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      background: var(--primary-color);
      color: white;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .theme-toggle:hover {
      background: var(--primary-hover);
      transform: scale(1.1);
    }

    .main-container {
      max-width: 1400px;
      margin: 40px auto;
      padding: 0 20px;
    }

    .checkout-header {
      text-align: center;
      margin-bottom: 40px;
      position: relative;
      overflow: hidden;
      padding: 30px 0;
      border-radius: 16px;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      box-shadow: 0 10px 20px rgba(99, 102, 241, 0.2);
      animation: gradientShift 8s ease infinite;
      background-size: 200% 200%;
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .checkout-header h1 {
      font-weight: 700;
      font-size: 2.5rem;
      margin-bottom: 10px;
      animation: fadeInUp 0.8s ease;
    }

    .checkout-header p {
      font-size: 1.1rem;
      opacity: 0.9;
      animation: fadeInUp 0.8s ease 0.2s both;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .checkout-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-top: 30px;
    }

    @media (max-width: 992px) {
      .checkout-grid {
        grid-template-columns: 1fr;
      }
    }

    .order-summary {
      background-color: var(--card-bg-light);
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 4px 20px var(--shadow-color);
      border: 1px solid var(--border-light);
      transition: all 0.3s ease;
    }

    .order-summary:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px var(--shadow-color);
    }

    .order-summary h2 {
      font-weight: 600;
      margin-bottom: 25px;
      color: var(--primary-color);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .cart-items {
      max-height: 400px;
      overflow-y: auto;
      padding-right: 10px;
    }

    .cart-item {
      display: flex;
      gap: 15px;
      padding: 15px 0;
      border-bottom: 1px solid var(--border-light);
      transition: all 0.3s ease;
      animation: slideIn 0.5s ease forwards;
      opacity: 0;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .cart-item:hover {
      background-color: rgba(99, 102, 241, 0.05);
      border-radius: 8px;
      padding: 15px;
    }

    .product-image {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 8px;
      box-shadow: 0 4px 8px var(--shadow-color);
      transition: all 0.3s ease;
    }

    .cart-item:hover .product-image {
      transform: scale(1.05);
      box-shadow: 0 6px 12px var(--shadow-color);
    }

    .product-info {
      flex: 1;
    }

    .product-title {
      font-weight: 600;
      margin-bottom: 5px;
      color: var(--text-dark);
    }

    .product-price {
      font-weight: 600;
      color: var(--primary-color);
      margin-bottom: 5px;
    }

    .product-quantity {
      color: var(--text-light);
      font-size: 0.9rem;
    }

    .order-total {
      margin-top: 25px;
      padding-top: 20px;
      border-top: 2px solid var(--border-light);
    }

    .total-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .total-label {
      color: var(--text-light);
    }

    .total-value {
      font-weight: 600;
    }

    .grand-total {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-top: 15px;
    }

    .checkout-form {
      background-color: var(--card-bg-light);
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 4px 20px var(--shadow-color);
      border: 1px solid var(--border-light);
      transition: all 0.3s ease;
    }

    .checkout-form:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px var(--shadow-color);
    }

    .checkout-form h2 {
      font-weight: 600;
      margin-bottom: 25px;
      color: var(--primary-color);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-group {
      margin-bottom: 20px;
      position: relative;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--text-dark);
    }

    .form-control {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid var(--border-light);
      border-radius: 8px;
      background-color: var(--bg-light);
      color: var(--text-dark);
      transition: all 0.3s ease;
      font-size: 1rem;
    }

    .form-control:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
      outline: none;
    }

    .error-message {
      color: var(--danger-color);
      font-size: 0.85rem;
      margin-top: 5px;
      display: none;
      animation: shake 0.3s ease;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      20%, 60% { transform: translateX(-5px); }
      40%, 80% { transform: translateX(5px); }
    }

    .payment-options {
      margin: 25px 0;
    }

    .payment-option {
      display: flex;
      align-items: center;
      padding: 15px;
      border: 1px solid var(--border-light);
      border-radius: 8px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .payment-option:hover {
      border-color: var(--primary-color);
      background-color: rgba(99, 102, 241, 0.05);
    }

    .payment-option.active {
      border-color: var(--primary-color);
      background-color: rgba(99, 102, 241, 0.1);
    }

    .payment-icon {
      margin-right: 15px;
      font-size: 1.5rem;
      color: var(--primary-color);
    }

    .payment-details {
      flex: 1;
    }

    .payment-title {
      font-weight: 600;
      margin-bottom: 3px;
    }

    .payment-description {
      color: var(--text-light);
      font-size: 0.9rem;
    }

    .btn-group {
      display: flex;
      gap: 15px;
      margin-top: 30px;
    }

    .btn {
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .btn-primary {
      background-color: var(--primary-color);
      border: none;
      color: white;
      flex: 1;
    }

    .btn-primary:hover {
      background-color: var(--primary-hover);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(99, 102, 241, 0.3);
    }

    .btn-outline {
      background-color: transparent;
      border: 1px solid var(--border-light);
      color: var(--text-dark);
    }

    .btn-outline:hover {
      background-color: rgba(99, 102, 241, 0.05);
      border-color: var(--primary-color);
      color: var(--primary-color);
    }

    .empty-cart {
      text-align: center;
      padding: 40px 0;
      animation: fadeIn 0.5s ease;
    }

    .empty-cart i {
      font-size: 3rem;
      color: var(--text-light);
      margin-bottom: 20px;
    }

    .empty-cart h4 {
      margin-bottom: 10px;
      color: var(--text-dark);
    }

    .empty-cart p {
      color: var(--text-light);
      margin-bottom: 20px;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .checkout-header h1 {
        font-size: 2rem;
      }
      
      .btn-group {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
      }
    }

    /* Animation delays for cart items */
    .cart-item:nth-child(1) { animation-delay: 0.1s; }
    .cart-item:nth-child(2) { animation-delay: 0.2s; }
    .cart-item:nth-child(3) { animation-delay: 0.3s; }
    .cart-item:nth-child(4) { animation-delay: 0.4s; }
    .cart-item:nth-child(5) { animation-delay: 0.5s; }

    /* Floating animation for header */
    .checkout-header::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
      animation: float 15s infinite linear;
      pointer-events: none;
    }

    @keyframes float {
      0% { transform: translate(0, 0); }
      25% { transform: translate(5%, 5%); }
      50% { transform: translate(10%, 0); }
      75% { transform: translate(5%, -5%); }
      100% { transform: translate(0, 0); }
    }

    /* Pulse animation for buttons */
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); }
      100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
    }

    .btn-pulse {
      animation: pulse 2s infinite;
    }

    /* Loading spinner */
    .spinner {
      display: none;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Success animation */
    @keyframes checkmark {
      0% { stroke-dashoffset: 50; }
      100% { stroke-dashoffset: 0; }
    }

    .checkmark {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: block;
      stroke-width: 3;
      stroke: #fff;
      stroke-miterlimit: 10;
      margin: 0 auto;
      stroke-dasharray: 50;
      stroke-dashoffset: 50;
      animation: checkmark 0.6s ease-in-out forwards;
    }
  </style>
</head>
<body>
  <button class="theme-toggle" id="themeToggle">
    <i class="fas fa-moon"></i>
  </button>

  <div class="main-container">
    <!-- Animated Header -->
    <header class="checkout-header">
      <div class="container">
        <h1>Complete Your Purchase</h1>
        <p>Review your items and enter your details to proceed</p>
      </div>
    </header>

    <!-- Main Checkout Grid -->
    <div class="checkout-grid">
      <!-- Order Summary Section -->
      <section class="order-summary">
        <h2><i class="fas fa-shopping-bag"></i> Order Summary</h2>
        
        <div class="cart-items" id="cartItems">
          <% if(cart && cart.length > 0) { %>
            <% let subtotal = 0; %>
            <% cart.forEach((item, index) => { %>
              <div class="cart-item" style="animation-delay: <%= index * 0.1 %>s">
                <img src="<%= item.product_image || 'https://via.placeholder.com/100?text=Product' %>" 
                     alt="<%= item.product_name %>" 
                     class="product-image">
                <div class="product-info">
                  <h4 class="product-title"><%= item.product_name %></h4>
                  <p class="product-price">₹<%= (item.product_price * item.product_quantity).toFixed(2) %></p>
                  <p class="product-quantity">Quantity: <%= item.product_quantity %></p>
                </div>
              </div>
              <% subtotal += item.product_price * item.product_quantity; %>
            <% }); %>
            
            <div class="order-total">
              <div class="total-row">
                <span class="total-label">Subtotal:</span>
                <span class="total-value">₹<%= subtotal.toFixed(2) %></span>
              </div>
              <div class="total-row">
                <span class="total-label">Shipping:</span>
                <span class="total-value">Free</span>
              </div>
              <div class="total-row">
                <span class="total-label">Tax:</span>
                <span class="total-value">₹<%= (subtotal * 0.18).toFixed(2) %></span>
              </div>
              <div class="total-row grand-total">
                <span>Total:</span>
                <span>₹<span id="totalAmount"><%= (subtotal * 1.18).toFixed(2) %></span></span>
              </div>
            </div>
          <% } else { %>
            <div class="empty-cart">
              <i class="fas fa-shopping-cart"></i>
              <h4>Your cart is empty</h4>
              <p>Add some products to your cart first</p>
              <a href="/products" class="btn btn-outline">Continue Shopping</a>
            </div>
          <% } %>
        </div>
      </section>

      <!-- Checkout Form Section -->
      <section class="checkout-form">
        <h2><i class="fas fa-user-edit"></i> Customer Details</h2>
        
        <form id="checkoutForm" action="/confirm_purchase1" method="POST">
          <div class="form-group">
            <label for="name" class="form-label">Full Name</label>
            <input type="text" id="name" name="name" class="form-control" placeholder="Enter your full name" required>
            <div id="nameError" class="error-message">Please enter your name</div>
          </div>
          
          <div class="form-group">
            <label for="email" class="form-label">Email Address</label>
            <input type="email" id="email" name="email" class="form-control" placeholder="Enter your email" required>
            <div id="emailError" class="error-message">Please enter a valid email address</div>
          </div>
          
          <div class="form-group">
            <label for="phone" class="form-label">Phone Number</label>
            <input type="tel" id="phone" name="phone" class="form-control" placeholder="Enter your phone number" required>
            <div id="phoneError" class="error-message">Please enter a valid 10-digit phone number</div>
          </div>
          
          <div class="form-group">
            <label for="address" class="form-label">Shipping Address</label>
            <textarea id="address" name="address" class="form-control" rows="4" placeholder="Enter your complete shipping address" required></textarea>
            <div id="addressError" class="error-message">Please enter your shipping address</div>
          </div>
          
          <div class="payment-options">
            <h3 class="form-label">Payment Method</h3>
            
            <div class="payment-option active" id="codOption">
              <div class="payment-icon">
                <i class="fas fa-money-bill-wave"></i>
              </div>
              <div class="payment-details">
                <div class="payment-title">Cash on Delivery</div>
                <div class="payment-description">Pay when you receive your order</div>
              </div>
            </div>
            
            <div class="payment-option" id="onlineOption">
              <div class="payment-icon">
                <i class="fas fa-credit-card"></i>
              </div>
              <div class="payment-details">
                <div class="payment-title">Online Payment</div>
                <div class="payment-description">Pay securely with Razorpay</div>
              </div>
            </div>
          </div>
          
          <input type="hidden" id="paymentMethod" name="paymentMethod" value="cod">
          <input type="hidden" id="hiddenTotalAmount" name="totalAmount" value="">
          
          <div class="btn-group">
            <button type="submit" class="btn btn-primary btn-pulse" id="submitBtn">
              <span id="submitText">Complete Order</span>
              <div class="spinner" id="submitSpinner"></div>
              <svg id="submitSuccess" class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52" style="display: none;">
                <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
                <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
              </svg>
            </button>
            <a href="/cart" class="btn btn-outline">
              <i class="fas fa-arrow-left"></i> Back to Cart
            </a>
          </div>
        </form>
      </section>
    </div>
  </div>

  <!-- Include Bootstrap JS and dependencies -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Razorpay checkout script -->
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  
  <script>
    $(document).ready(function() {
      // Theme toggle functionality
      const themeToggle = $('#themeToggle');
      const currentTheme = localStorage.getItem('theme') || 'light';
      
      // Set initial theme
      if (currentTheme === 'dark') {
        $('body').attr('data-theme', 'dark');
        themeToggle.html('<i class="fas fa-sun"></i>');
      } else {
        $('body').attr('data-theme', 'light');
        themeToggle.html('<i class="fas fa-moon"></i>');
      }
      
      // Toggle theme
      themeToggle.on('click', function() {
        if ($('body').attr('data-theme') === 'light') {
          $('body').attr('data-theme', 'dark');
          themeToggle.html('<i class="fas fa-sun"></i>');
          localStorage.setItem('theme', 'dark');
        } else {
          $('body').attr('data-theme', 'light');
          themeToggle.html('<i class="fas fa-moon"></i>');
          localStorage.setItem('theme', 'light');
        }
      });
      
      // Set the total amount value in the hidden input field
      const totalAmount = $('#totalAmount').text().trim();
      $('#hiddenTotalAmount').val(totalAmount);
      
      // Payment method selection
      $('.payment-option').on('click', function() {
        $('.payment-option').removeClass('active');
        $(this).addClass('active');
        
        if ($(this).attr('id') === 'onlineOption') {
          $('#paymentMethod').val('online');
          $('#submitText').text('Pay Now');
        } else {
          $('#paymentMethod').val('cod');
          $('#submitText').text('Complete Order');
        }
      });
      
      // Form validation function
      function validateForm() {
        let isValid = true;
        
        // Validate name
        if ($('#name').val().trim() === '') {
          $('#nameError').show();
          isValid = false;
        } else {
          $('#nameError').hide();
        }
        
        // Validate email
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test($('#email').val())) {
          $('#emailError').show();
          isValid = false;
        } else {
          $('#emailError').hide();
        }
        
        // Validate phone
        const phoneRegex = /^[0-9]{10}$/;
        if (!phoneRegex.test($('#phone').val())) {
          $('#phoneError').show();
          isValid = false;
        } else {
          $('#phoneError').hide();
        }
        
        // Validate address
        if ($('#address').val().trim() === '') {
          $('#addressError').show();
          isValid = false;
        } else {
          $('#addressError').hide();
        }
        
        return isValid;
      }
      
      // Handle form submission
      $('#checkoutForm').on('submit', function(e) {
        e.preventDefault();
        
        // Validate form before proceeding
        if (!validateForm()) {
          return false;
        }
        
        // Check if cart is empty
        if (parseFloat(totalAmount) <= 0) {
          alert('Your cart is empty. Please add products before checkout.');
          return false;
        }
        
        const paymentMethod = $('#paymentMethod').val();
        const form = this;
        
        // Show loading spinner
        $('#submitText').hide();
        $('#submitSpinner').show();
        $('#submitBtn').prop('disabled', true);
        
        if (paymentMethod === 'online') {
          // Process online payment
          processOnlinePayment(form);
        } else {
          // Process COD - submit form directly
          setTimeout(() => {
            form.submit();
          }, 1000);
        }
      });
      
      // Process online payment with Razorpay
      function processOnlinePayment(form) {
        const amount = parseFloat(totalAmount) * 100; // Razorpay expects amount in paise
        
        const options = {
          "key": "rzp_test_wtrBaXbtEKahAZ", // Replace with your Razorpay key
          "amount": amount,
          "currency": "INR",
          "name": "Chain Core",
          "description": "Order Payment",
          "image": "<%=user_image%>",
          "prefill": {
            "name": $('#name').val(),
            "email": $('#email').val(),
            "contact": $('#phone').val()
          },
          "notes": {
            "address": $('#address').val()
          },
          "theme": {
            "color": "#6366f1"
          },
          "handler": function(response) {
            // On successful payment
            showSuccessAnimation();
            
            // Create hidden inputs with payment details
            $('<input>').attr({
              type: 'hidden',
              name: 'razorpay_payment_id',
              value: response.razorpay_payment_id
            }).appendTo(form);
            
            $('<input>').attr({
              type: 'hidden',
              name: 'razorpay_order_id',
              value: response.razorpay_order_id || ''
            }).appendTo(form);
            
            $('<input>').attr({
              type: 'hidden',
              name: 'razorpay_signature',
              value: response.razorpay_signature || ''
            }).appendTo(form);
            
            // Submit the form after animation
            setTimeout(() => {
              form.submit();
            }, 1500);
          },
          "modal": {
            "ondismiss": function() {
              resetSubmitButton();
            }
          }
        };
        
        const rzp1 = new Razorpay(options);
        rzp1.open();
      }
      
      // Show success animation
      function showSuccessAnimation() {
        $('#submitSpinner').hide();
        $('#submitSuccess').show();
        $('#submitBtn').css('background-color', '#10b981');
      }
      
      // Reset submit button state
      function resetSubmitButton() {
        $('#submitText').show();
        $('#submitSpinner').hide();
        $('#submitSuccess').hide();
        $('#submitBtn').prop('disabled', false);
        $('#submitBtn').css('background-color', '');
      }
      
      // Input validation on blur
      $('#name').on('blur', function() {
        if ($(this).val().trim() === '') {
          $('#nameError').show();
        } else {
          $('#nameError').hide();
        }
      });
      
      $('#email').on('blur', function() {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test($(this).val())) {
          $('#emailError').show();
        } else {
          $('#emailError').hide();
        }
      });
      
      $('#phone').on('blur', function() {
        const phoneRegex = /^[0-9]{10}$/;
        if (!phoneRegex.test($(this).val())) {
          $('#phoneError').show();
        } else {
          $('#phoneError').hide();
        }
      });
      
      $('#address').on('blur', function() {
        if ($(this).val().trim() === '') {
          $('#addressError').show();
        } else {
          $('#addressError').hide();
        }
      });
      
      // Add hover effect to cart items
      $('.cart-item').hover(
        function() {
          $(this).css('transform', 'translateX(5px)');
        },
        function() {
          $(this).css('transform', 'translateX(0)');
        }
      );
    });
  </script>
</body>
</html>